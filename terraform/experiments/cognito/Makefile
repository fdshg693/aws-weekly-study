# Makefile for Cognito Terraform Project
# =======================================
# ä¾¿åˆ©ãªã‚³ãƒãƒ³ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’æä¾›ã—ã¾ã™
#
# ä½¿ç”¨æ–¹æ³•:
#   make help     - ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
#   make init     - TerraformåˆæœŸåŒ–
#   make plan     - ãƒ‡ãƒ—ãƒ­ã‚¤è¨ˆç”»ã‚’è¡¨ç¤ºï¼ˆé–‹ç™ºç’°å¢ƒï¼‰
#   make apply    - ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œï¼ˆé–‹ç™ºç’°å¢ƒï¼‰
#   make destroy  - ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤ï¼ˆé–‹ç™ºç’°å¢ƒï¼‰
#   make test     - èªè¨¼ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ

.PHONY: help init fmt validate plan apply destroy output test clean plan-prod apply-prod destroy-prod frontend-install frontend-dev frontend-build frontend-deploy

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ç’°å¢ƒè¨­å®š
ENV ?= dev
REGION ?= ap-northeast-1

help: ## ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
	@echo "Available commands:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "Usage examples:"
	@echo "  make plan          - é–‹ç™ºç’°å¢ƒã®ãƒ—ãƒ©ãƒ³ã‚’è¡¨ç¤º"
	@echo "  make apply         - é–‹ç™ºç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤"
	@echo "  make plan-prod     - æœ¬ç•ªç’°å¢ƒã®ãƒ—ãƒ©ãƒ³ã‚’è¡¨ç¤º"
	@echo "  make apply-prod    - æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤"
	@echo "  make test          - èªè¨¼ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ"
	@echo "  make output        - å‡ºåŠ›å€¤ã‚’è¡¨ç¤º"

init: ## TerraformåˆæœŸåŒ–
	@echo "ğŸ”§ Initializing Terraform..."
	terraform init

fmt: ## ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
	@echo "ğŸ¨ Formatting Terraform code..."
	terraform fmt -recursive

validate: ## è¨­å®šã®æ¤œè¨¼
	@echo "âœ… Validating Terraform configuration..."
	terraform validate

plan: init ## ãƒ‡ãƒ—ãƒ­ã‚¤è¨ˆç”»ã‚’è¡¨ç¤ºï¼ˆé–‹ç™ºç’°å¢ƒï¼‰
	@echo "ğŸ“‹ Planning deployment for dev environment..."
	terraform plan -var-file="dev.tfvars"

apply: init ## ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œï¼ˆé–‹ç™ºç’°å¢ƒï¼‰
	@echo "ğŸš€ Applying Terraform configuration for dev environment..."
	terraform apply -var-file="dev.tfvars"

destroy: ## ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤ï¼ˆé–‹ç™ºç’°å¢ƒï¼‰
	@echo "ğŸ’¥ Destroying dev environment resources..."
	terraform destroy -var-file="dev.tfvars"

plan-prod: init ## ãƒ‡ãƒ—ãƒ­ã‚¤è¨ˆç”»ã‚’è¡¨ç¤ºï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
	@echo "ğŸ“‹ Planning deployment for production environment..."
	terraform plan -var-file="prod.tfvars"

apply-prod: init ## ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
	@echo "ğŸš€ Applying Terraform configuration for production environment..."
	@echo "âš ï¸  WARNING: This will deploy to PRODUCTION!"
	@read -p "Are you sure? [y/N] " -n 1 -r; \
	echo ""; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		terraform apply -var-file="prod.tfvars"; \
	else \
		echo "Cancelled."; \
	fi

destroy-prod: ## ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
	@echo "ğŸ’¥ Destroying production environment resources..."
	@echo "âš ï¸  WARNING: This will DELETE production resources!"
	@read -p "Are you sure? [y/N] " -n 1 -r; \
	echo ""; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		terraform destroy -var-file="prod.tfvars"; \
	else \
		echo "Cancelled."; \
	fi

output: ## å‡ºåŠ›å€¤ã‚’è¡¨ç¤º
	@echo "ğŸ“¤ Terraform outputs:"
	@terraform output

output-json: ## å‡ºåŠ›å€¤ã‚’JSONå½¢å¼ã§è¡¨ç¤º
	@terraform output -json

test: ## èªè¨¼ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ
	@echo "ğŸ§ª Running authentication flow test..."
	@if [ ! -f test_auth_flow.sh ]; then \
		echo "âŒ test_auth_flow.sh not found"; \
		exit 1; \
	fi
	@chmod +x test_auth_flow.sh
	@./test_auth_flow.sh

clean: ## Terraformã®ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
	@echo "ğŸ§¹ Cleaning up Terraform files..."
	rm -rf .terraform
	rm -f .terraform.lock.hcl
	rm -f terraform.tfstate.backup

show: ## ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
	@terraform show

graph: ## ãƒªã‚½ãƒ¼ã‚¹ã®ä¾å­˜é–¢ä¿‚ã‚°ãƒ©ãƒ•ã‚’ç”Ÿæˆ
	@echo "ğŸ“Š Generating dependency graph..."
	@terraform graph | dot -Tpng > graph.png
	@echo "Graph saved to graph.png"

console: ## Terraform consoleã‚’èµ·å‹•
	@terraform console

# ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚³ãƒãƒ³ãƒ‰
get-pool-id: ## User Pool IDã‚’å–å¾—
	@terraform output -raw user_pool_id

get-client-id: ## Client IDã‚’å–å¾—
	@terraform output -raw user_pool_client_id

get-region: ## Regionã‚’å–å¾—
	@terraform output -raw aws_region

set-env: ## ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šï¼ˆsourceä½¿ç”¨ï¼‰
	@echo "âš ï¸  Run this command with 'source' or '.'"
	@echo "Example: source <(make set-env)"
	@echo ""
	@echo "export REGION=$$(terraform output -raw aws_region)"
	@echo "export USER_POOL_ID=$$(terraform output -raw user_pool_id)"
	@echo "export CLIENT_ID=$$(terraform output -raw user_pool_client_id)"

all: fmt validate plan ## ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€æ¤œè¨¼ã€ãƒ—ãƒ©ãƒ³ã‚’å®Ÿè¡Œ

# ========================================
# Frontend Commands
# ========================================

frontend-install: ## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
	@echo "ğŸ“¦ Installing frontend dependencies..."
	cd frontend && npm install

frontend-dev: ## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ï¼ˆlocalhost:5173ï¼‰
	@echo "ğŸ”§ Starting frontend dev server..."
	cd frontend && npm run dev

frontend-build: ## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰
	@echo "ğŸ”¨ Building frontend..."
	cd frontend && npm run build

frontend-deploy: frontend-build ## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’Amplifyã«ãƒ‡ãƒ—ãƒ­ã‚¤
	@echo "ğŸš€ Deploying frontend to Amplify..."
	@APP_ID=$$(terraform output -raw amplify_app_id) && \
	cd frontend/dist && zip -r /tmp/amplify-deploy.zip . && \
	DEPLOY_INFO=$$(aws amplify create-deployment --app-id $$APP_ID --branch-name main --region $(REGION) --output json) && \
	UPLOAD_URL=$$(echo $$DEPLOY_INFO | python3 -c "import sys,json; print(json.load(sys.stdin)['zipUploadUrl'])") && \
	JOB_ID=$$(echo $$DEPLOY_INFO | python3 -c "import sys,json; print(json.load(sys.stdin)['jobId'])") && \
	curl -s --request PUT --upload-file /tmp/amplify-deploy.zip "$$UPLOAD_URL" > /dev/null && \
	aws amplify start-deployment --app-id $$APP_ID --branch-name main --job-id $$JOB_ID --region $(REGION) > /dev/null && \
	rm -f /tmp/amplify-deploy.zip && \
	echo "âœ… Deployed to: $$(terraform output -raw amplify_app_url)"

.DEFAULT_GOAL := help
