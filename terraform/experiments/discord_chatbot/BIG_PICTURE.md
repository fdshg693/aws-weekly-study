# Discord Chatbot on AWS - 全体像

## システムアーキテクチャ

```
┌────────────────────────────────────────────────────────────────────────────┐
│                            AWS Cloud Environment                           │
│                                                                            │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                      VPC (デフォルトVPC)                              │ │
│  │                                                                        │ │
│  │   ┌─────────────────────────────────────────────────────────────┐    │ │
│  │   │ EC2 Instance (t2.micro / Amazon Linux 2023)                 │    │ │
│  │   │                                                             │    │ │
│  │   │  ┌──────────────────────────────────────────────────────┐  │    │ │
│  │   │  │ Discord Bot Service (systemd)                        │  │    │ │
│  │   │  │                                                      │  │    │ │
│  │   │  │  • Python 3.11                                       │  │    │ │
│  │   │  │  • discord.py (Discord API クライアント)             │  │    │ │
│  │   │  │  • boto3 (AWS SDK)                                   │  │    │ │
│  │   │  │  • /opt/discord-bot/echo.py (メインスクリプト)       │  │    │ │
│  │   │  │                                                      │  │    │ │
│  │   │  │  動作: メンションされたメッセージをエコーバック      │  │    │ │
│  │   │  └──────────────────────────────────────────────────────┘  │    │ │
│  │   │                        │                                    │    │ │
│  │   │                        │ IAMロール経由で権限取得            │    │ │
│  │   │                        ↓                                    │    │ │
│  │   │  ┌─────────────────────────────────────────────┐            │    │ │
│  │   │  │ IAM Instance Profile                        │            │    │ │
│  │   │  │  • S3 GetObject (特定バケット/echo.py限定) │            │    │ │
│  │   │  │  • Secrets Manager GetSecretValue           │            │    │ │
│  │   │  │  • Systems Manager (Session Manager用)      │            │    │ │
│  │   │  │  • CloudWatch Logs PutLogEvents             │            │    │ │
│  │   │  └─────────────────────────────────────────────┘            │    │ │
│  │   └─────────────────────────────────────────────────────────────┘    │ │
│  │                                                                        │ │
│  │   ┌──────────────────────┐                                            │ │
│  │   │ Security Group       │                                            │ │
│  │   │                      │                                            │ │
│  │   │  Inbound:            │                                            │ │
│  │   │   • SSH (22)         │ ← 自分のIPのみ許可 (xxx.xxx.xxx.xxx/32)   │ │
│  │   │                      │                                            │ │
│  │   │  Outbound:           │                                            │ │
│  │   │   • HTTPS (443)      │ → Discord API、AWS API通信用             │ │
│  │   └──────────────────────┘                                            │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │ AWSマネージドサービス                                                │  │
│  │                                                                     │  │
│  │  ┌──────────────────┐   ┌──────────────────┐   ┌───────────────┐  │  │
│  │  │ S3 Bucket        │   │ Secrets Manager  │   │ CloudWatch    │  │  │
│  │  │                  │   │                  │   │ Logs          │  │  │
│  │  │ • echo.py保管    │   │ • Bot Token保管  │   │ • Botログ保管 │  │  │
│  │  │ • バージョニング │   │ • KMS暗号化      │   │ • 監視・検索  │  │  │
│  │  │ • 一元管理       │   │ • IAM権限制御    │   │               │  │  │
│  │  └──────────────────┘   └──────────────────┘   └───────────────┘  │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ HTTPS (443)
                                    ↓
                       ┌────────────────────────────┐
                       │  Discord API               │
                       │                            │
                       │  • Botの認証・接続         │
                       │  • メッセージの送受信      │
                       │  • イベント通知            │
                       └────────────────────────────┘
```

## デプロイフロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 1. 開発環境での準備                                                      │
└─────────────────────────────────────────────────────────────────────────┘
  │
  ├─ Discord Bot Tokenを環境変数に設定
  │   export TF_VAR_discord_bot_token="YOUR_TOKEN"
  │
  ├─ SSH鍵ペアを生成
  │   ssh-keygen -t rsa -b 4096 -f ./discord-bot-key
  │
  └─ dev.tfvarsを編集 (自分のIPアドレスを設定)
      my_ip = "xxx.xxx.xxx.xxx/32"

        ↓

┌─────────────────────────────────────────────────────────────────────────┐
│ 2. Terraform Apply (インフラ構築)                                       │
└─────────────────────────────────────────────────────────────────────────┘
  │
  ├─ terraform init
  ├─ terraform plan -var-file="dev.tfvars"
  └─ terraform apply -var-file="dev.tfvars"

        ↓

  作成されるリソース:
  • EC2インスタンス (t2.micro)
  • S3バケット (Botスクリプト保管用)
  • Secrets Manager (Bot Token保管用)
  • IAMロール + ポリシー
  • セキュリティグループ
  • SSH鍵ペア (AWS Key Pair)

        ↓

┌─────────────────────────────────────────────────────────────────────────┐
│ 3. BotスクリプトをS3にアップロード                                       │
└─────────────────────────────────────────────────────────────────────────┘
  │
  └─ aws s3 cp python/echo.py s3://[BUCKET_NAME]/echo.py

        ↓

┌─────────────────────────────────────────────────────────────────────────┐
│ 4. EC2起動 + User Data実行 (自動セットアップ)                           │
└─────────────────────────────────────────────────────────────────────────┘
  │
  ├─ Python 3.11 + pip インストール
  ├─ discord.py, boto3 インストール
  ├─ /opt/discord-bot/ ディレクトリ作成
  ├─ S3から echo.py ダウンロード
  ├─ Secrets Manager から Bot Token 取得
  ├─ systemd サービスファイル作成
  │   (/etc/systemd/system/discord-bot.service)
  ├─ サービス有効化・起動
  └─ ログ記録 (/var/log/discord-bot-setup.log)

        ↓

┌─────────────────────────────────────────────────────────────────────────┐
│ 5. Botの起動・Discord APIに接続                                         │
└─────────────────────────────────────────────────────────────────────────┘
  │
  ├─ Secrets ManagerからBot Tokenを読み込み
  ├─ Discord APIに接続
  ├─ "Logged on as YourBotName#1234!" をログ出力
  └─ メッセージイベントを待機

        ↓

┌─────────────────────────────────────────────────────────────────────────┐
│ 6. 動作確認                                                             │
└─────────────────────────────────────────────────────────────────────────┘
  │
  ├─ Discordサーバーで @BotName メッセージ
  ├─ Botが同じメッセージをエコーバック
  └─ ✅ デプロイ完了！
```

## データフロー

### Botの起動時

```
EC2 Instance
    │
    ├─→ IAM Role を使用して認証
    │
    ├─→ Secrets Manager
    │      └─ Bot Token を取得 (GetSecretValue)
    │
    ├─→ S3 Bucket
    │      └─ echo.py をダウンロード (GetObject)
    │
    └─→ Discord API
           └─ Bot Token で認証・接続
```

### メッセージ受信時

```
Discord Server
    │
    │ (ユーザーがBotにメンション)
    ↓
Discord API
    │
    │ (WebSocket経由でイベント通知)
    ↓
EC2 Instance (discord-bot service)
    │
    ├─ メッセージ内容を解析
    ├─ エコーバックするメッセージを生成
    │
    └─→ Discord API
           └─ メッセージを送信 (HTTP POST)
```

### ログの流れ

```
discord-bot service
    │
    │ (標準出力・標準エラー出力)
    ↓
journald (systemd journal)
    │
    ├─ journalctl -u discord-bot -f で確認可能
    │
    └─→ (オプション) CloudWatch Logs Agent
           └─ CloudWatch Logs に転送
```

## ファイル構成とTerraformモジュール

```
terraform/discord_chatbot/
│
├── [設定ファイル]
│   ├── provider.tf          → AWSプロバイダー設定 (リージョン等)
│   ├── variables.tf         → 変数定義 (型、デフォルト値、バリデーション)
│   └── dev.tfvars           → 環境固有の変数値 (my_ip, region等)
│
├── [インフラ定義]
│   ├── main.tf              → EC2インスタンス、AMI取得、SSH鍵ペア
│   ├── s3.tf                → S3バケット (バージョニング有効化)
│   ├── secrets.tf           → Secrets Manager (Bot Token保管)
│   ├── security_groups.tf   → SSH/HTTPS通信ルール
│   ├── iam.tf               → IAMロール + ポリシー (S3, Secrets Manager)
│   └── outputs.tf           → デプロイ後の出力 (IP, 接続コマンド)
│
├── [アプリケーション]
│   ├── python/echo.py       → Discord Botメインスクリプト (S3にアップロード)
│   └── user_data.sh         → EC2初回起動時の自動セットアップスクリプト
│
├── [認証情報]
│   ├── discord-bot-key      → SSH秘密鍵 (.gitignore済み)
│   └── discord-bot-key.pub  → SSH公開鍵
│
└── [ドキュメント]
    ├── README.md            → プロジェクト概要・デプロイ手順
    ├── BIG_PICTURE.md       → このファイル (全体像・アーキテクチャ図)
    └── IMPROVEMENT_PLAN.md  → 今後の改善計画
```

## セキュリティ設計

### 認証情報の管理

| 情報 | 保存場所 | 暗号化 | アクセス方法 |
|------|----------|--------|--------------|
| Discord Bot Token | AWS Secrets Manager | KMS暗号化 | IAMロール経由でGetSecretValue |
| SSH秘密鍵 | ローカル環境 | - | ファイルパーミッション600で保護 |
| AWS認証情報 | ~/.aws/credentials | - | EC2にはIAMロールで権限付与 (アクセスキー不要) |

### 最小権限の原則

**IAMポリシー設計**:
```json
{
  "S3アクセス": {
    "対象": "特定バケットの echo.py のみ",
    "権限": "GetObject (読み取りのみ)"
  },
  "Secrets Manager": {
    "対象": "特定シークレット (discord-bot-dev-token) のみ",
    "権限": "GetSecretValue (読み取りのみ)"
  },
  "Systems Manager": {
    "対象": "自インスタンスのみ",
    "権限": "Session Manager接続用 (SSH代替)"
  }
}
```

### ネットワークセキュリティ

**セキュリティグループ設計**:
```
Inbound:
  • SSH (22) ← 自分のIPアドレスのみ許可 (xxx.xxx.xxx.xxx/32)
  ⚠️ 0.0.0.0/0 (全世界公開) は絶対に使用しない

Outbound:
  • HTTPS (443) → Discord API、AWS API通信用
  • すべてのトラフィック → インターネットアクセス (パッケージ更新用)
```

## 運用フロー

### 通常運用

```
┌─────────────────────────────────────────┐
│ 日常的な監視                             │
├─────────────────────────────────────────┤
│ • journalctl -u discord-bot -f         │
│   (リアルタイムでログ確認)              │
│                                         │
│ • systemctl status discord-bot         │
│   (サービスの状態確認)                  │
│                                         │
│ • CloudWatch Logs (オプション)         │
│   (過去のログを検索・分析)              │
└─────────────────────────────────────────┘
```

### コード更新

```
┌─────────────────────────────────────────┐
│ 1. ローカルで echo.py を編集            │
└─────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────┐
│ 2. S3にアップロード                     │
│    aws s3 cp python/echo.py s3://...    │
└─────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────┐
│ 3. EC2でS3から最新版をダウンロード      │
│    sudo aws s3 cp s3://... /opt/...     │
└─────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────┐
│ 4. サービス再起動                       │
│    sudo systemctl restart discord-bot   │
└─────────────────────────────────────────┘
```

### トラブル発生時

```
┌─────────────────────────────────────────┐
│ 1. ログを確認                           │
│    journalctl -u discord-bot -n 50     │
└─────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────┐
│ 2. サービスの状態を確認                 │
│    systemctl status discord-bot         │
└─────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────┐
│ 3. 手動でBotを実行してテスト            │
│    cd /opt/discord-bot                  │
│    python3 echo.py                      │
└─────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────┐
│ 4. 必要に応じて修正・再起動             │
└─────────────────────────────────────────┘
```

## コスト見積もり

### AWS無料利用枠内の場合

| サービス | 無料枠 | 本プロジェクト | 超過の可能性 |
|---------|--------|---------------|-------------|
| EC2 (t2.micro) | 750時間/月 | 720時間/月 (常時稼働) | ❌ 超過しない |
| EBS (汎用SSD) | 30GB | 8GB | ❌ 超過しない |
| データ転送 (アウトバウンド) | 15GB/月 | < 1GB/月 | ❌ 超過しない |
| S3 (標準ストレージ) | 5GB | < 1MB | ❌ 超過しない |
| Secrets Manager | - | 1個 | ⚠️ $0.40/月 (有料) |

**月額概算**: 約$0.40 (Secrets Managerのみ)

### 無料枠終了後 (12ヶ月後)

| サービス | 月額概算 |
|---------|---------|
| EC2 (t2.micro) | $8.50 |
| EBS (8GB) | $0.80 |
| データ転送 | $0.10 |
| S3 | $0.01 |
| Secrets Manager | $0.40 |
| **合計** | **約$9.81/月** |

## 今後の拡張案

### 1. 高可用性構成

```
                  ┌──────────────────┐
                  │ Application LB   │
                  └──────────────────┘
                      │          │
            ┌─────────┴─────┐    │
            ↓               ↓    ↓
      ┌──────────┐    ┌──────────┐
      │ EC2 (AZ-a)│    │ EC2 (AZ-c)│
      └──────────┘    └──────────┘
            │               │
            └───────┬───────┘
                    ↓
            ┌──────────────┐
            │ RDS (Multi-AZ)│
            └──────────────┘
```

### 2. CI/CD パイプライン

```
GitHub
  │
  │ (git push)
  ↓
GitHub Actions
  │
  ├─ terraform validate
  ├─ terraform plan
  ├─ pytest (テスト実行)
  │
  └─→ terraform apply (本番環境)
```

### 3. モニタリング強化

- CloudWatch Alarms (CPUやメモリの監視)
- SNS通知 (Botダウン時にメール通知)
- X-Ray (パフォーマンストレース)

---

## まとめ

このプロジェクトは、**TerraformによるIaC**、**AWS Secrets Managerによるセキュアな認証情報管理**、**systemdによる自動起動・再起動**を組み合わせた、実践的なDiscord Botデプロイ環境です。

**学習ポイント**:
- ✅ Infrastructure as Code (Terraform)
- ✅ AWS IAMロールによる権限管理
- ✅ Secrets Managerでの認証情報管理
- ✅ S3によるコード管理とバージョニング
- ✅ User Dataによる自動セットアップ
- ✅ systemdによるプロセス管理
- ✅ セキュリティグループによるネットワーク制御
