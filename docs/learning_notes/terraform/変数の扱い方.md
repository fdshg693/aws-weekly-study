# Terraformの変数設定について

Terraformで変数を使う方法を詳しく説明します。

## 1. 変数の定義（variable ブロック）

変数を定義するには、`.tf`ファイルで`variable`ブロックを使用します。基本的な構文は以下の通りです：

```hcl
variable "変数名" {
  type        = データ型
  default     = デフォルト値
  description = "説明"
  sensitive   = true/false
}
```

**例：**

```hcl
variable "environment" {
  type        = string
  default     = "dev"
  description = "環境名（dev, staging, prod）"
}

variable "instance_count" {
  type        = number
  default     = 2
  description = "インスタンス数"
}

variable "tags" {
  type        = map(string)
  default     = {}
  description = "リソースに付与するタグ"
}
```

## 2. サポートされているデータ型

Terraformでは以下のデータ型が使えます：

**基本型：** `string`（文字列）、`number`（数値）、`bool`（真偽値）

**複合型：** `list(string)`（文字列のリスト）、`map(string)`（キー値マップ）、`set(string)`（重複なしセット）

**複雑型：** `object({ key = type })`（オブジェクト）、`tuple([ type1, type2 ])`（タプル）

**例：**

```hcl
variable "availability_zones" {
  type = list(string)
  default = ["us-east-1a", "us-east-1b"]
}

variable "subnet_config" {
  type = object({
    name       = string
    cidr_block = string
    public     = bool
  })
}
```

## 3. 変数値の指定方法

### （1）コマンドラインで指定

```bash
terraform apply -var="environment=prod" -var="instance_count=5"
```

### （2）`.tfvars`ファイルで指定

`terraform.tfvars`（または`*.tfvars`）ファイルを作成して変数値を定義します：

```hcl
environment   = "prod"
instance_count = 3
tags = {
  Owner       = "DevTeam"
  CostCenter  = "Engineering"
}
```

実行時に指定：
```bash
terraform apply -var-file="terraform.tfvars"
terraform apply -var-file="dev.tfvars"
```

### （3）環境変数で指定

`TF_VAR_`プレフィックスを使用します：

```bash
export TF_VAR_environment=staging
export TF_VAR_instance_count=4
terraform apply
```

### （4）対話型プロンプト

変数に`default`が設定されていない場合、実行時にプロンプトで入力を求められます：

```bash
terraform apply
# 変数の入力を求められる
```

## 4. 変数の使用方法

テンプレート内で`var.変数名`で参照します：

```hcl
resource "aws_instance" "example" {
  ami           = "ami-0c55b159cbfafe1f0"
  instance_type = "t2.micro"
  count         = var.instance_count

  tags = merge(
    var.tags,
    {
      Name        = "instance-${count.index + 1}"
      Environment = var.environment
    }
  )
}
```

## 5. 実用的な例

`variables.tf`に定義：

```hcl
variable "aws_region" {
  type        = string
  default     = "us-east-1"
  description = "AWSリージョン"
}

variable "environment" {
  type        = string
  default     = "dev"
  description = "環境名"
  
  validation {
    condition     = contains(["dev", "staging", "prod"], var.environment)
    error_message = "environmentはdev, staging, prodのいずれかである必要があります。"
  }
}

variable "db_password" {
  type        = string
  sensitive   = true
  description = "データベースパスワード"
}
```

`dev.tfvars`に定義：

```hcl
aws_region  = "us-east-1"
environment = "dev"
```

実行：

```bash
terraform plan -var-file="dev.tfvars" -var="db_password=MySecurePassword123"
```

## 6. ベストプラクティス

- **sensitive = true** を機密情報に指定（ログに表示されない）
- **validation ブロック** で値の検証を行う
- **複数環境用に別々のtfvarsファイル** を作成（`dev.tfvars`, `prod.tfvars`など）
- **`.gitignore`に`*.tfvars`を追加** して、機密情報をバージョン管理から除外

ご質問や具体的なユースケースがあれば、お知らせください！