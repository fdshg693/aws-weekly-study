Terraformのモジュール分割について説明します。

## 単なるフォルダ分けでは不十分

**重要:** 単にフォルダを分けただけではモジュールになりません。明示的に`module`ブロックで呼び出す必要があります。

## モジュールの基本構造

```
project/
├── main.tf              # ルートモジュール
├── variables.tf
├── outputs.tf
└── modules/
    ├── network/         # 子モジュール1
    │   ├── main.tf
    │   ├── variables.tf
    │   └── outputs.tf
    └── compute/         # 子モジュール2
        ├── main.tf
        ├── variables.tf
        └── outputs.tf
```

## モジュールの作り方

### 1. 子モジュールの定義

```hcl
# modules/network/main.tf
locals {
  vpc_cidr = "10.0.0.0/16"  # このモジュール内でのみ有効
}

resource "aws_vpc" "main" {
  cidr_block = local.vpc_cidr
  
  tags = {
    Name = var.vpc_name
  }
}

# modules/network/variables.tf
variable "vpc_name" {
  type        = string
  description = "VPC name"
}

# modules/network/outputs.tf
output "vpc_id" {
  value       = aws_vpc.main.id
  description = "VPC ID"
}
```

### 2. ルートモジュールから呼び出し

```hcl
# main.tf (ルートモジュール)
module "network" {
  source = "./modules/network"  # 明示的にモジュールを指定
  
  vpc_name = "my-vpc"
}

module "compute" {
  source = "./modules/compute"
  
  vpc_id = module.network.vpc_id  # 他のモジュールのoutputを参照
}

# outputs.tf
output "vpc_id" {
  value = module.network.vpc_id
}
```

## フォルダだけ分けた場合(モジュール化しない場合)

```
project/
├── network/
│   └── vpc.tf       # 単なるファイル分割
└── compute/
    └── ec2.tf       # 単なるファイル分割
```

この場合:
- `terraform apply`を実行するディレクトリに全ての`.tf`ファイルが必要
- 全て同じスコープ(ルートモジュール)として扱われる
- `locals`は全ファイル間で共有される
- **スコープの分離はできない**

## モジュール化のメリット

### 1. **スコープの分離**
```hcl
# modules/network/main.tf
locals {
  private_cidr = "10.0.1.0/24"  # 外部から直接アクセス不可
}

# main.tf
# local.private_cidr は参照できない(エラーになる)
# module.network.vpc_id のようにoutputを通してのみ取得可能
```

### 2. **再利用性**
```hcl
module "network_prod" {
  source      = "./modules/network"
  vpc_name    = "prod-vpc"
  environment = "prod"
}

module "network_dev" {
  source      = "./modules/network"
  vpc_name    = "dev-vpc"
  environment = "dev"
}
```

### 3. **依存関係の明確化**
```hcl
module "database" {
  source = "./modules/database"
  
  vpc_id     = module.network.vpc_id
  subnet_ids = module.network.private_subnet_ids
}
# module.network が先に作成されることが保証される
```

## 実際の分割例

### シンプルな例
```hcl
# main.tf
terraform {
  required_version = ">= 1.0"
}

module "vpc" {
  source = "./modules/vpc"
  
  vpc_cidr = "10.0.0.0/16"
  name     = "main-vpc"
}

module "app_server" {
  source = "./modules/ec2"
  
  vpc_id        = module.vpc.vpc_id
  subnet_id     = module.vpc.subnet_ids[0]
  instance_type = "t3.micro"
}
```

### 実践的な例
```hcl
# main.tf
module "network" {
  source = "./modules/network"
  
  project_name = var.project_name
  environment  = var.environment
}

module "security" {
  source = "./modules/security"
  
  vpc_id = module.network.vpc_id
}

module "application" {
  source = "./modules/application"
  
  vpc_id            = module.network.vpc_id
  subnet_ids        = module.network.private_subnet_ids
  security_group_id = module.security.app_sg_id
}
```

## まとめ

- **フォルダを分けるだけ**: 単なるファイル整理、全て同じスコープ
- **モジュール化**: `module`ブロックで明示的に呼び出し、スコープが分離される
- スコープ管理が必要なら**必ずモジュール化**する
- モジュール間のデータ受け渡しは`variables`(入力)と`outputs`(出力)で行う

適切なモジュール分割により、保守性と再利用性が大幅に向上します。