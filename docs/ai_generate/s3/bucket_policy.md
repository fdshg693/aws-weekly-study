# S3 バケットポリシー概要

## バケットポリシーとは

S3バケットポリシーは、バケット上のアクセス制御を定義するJSON形式のポリシードキュメントです。バケットに対する誰が、何をできるか/できないかを制御します。

## バケットポリシーで設定できる主要要素

### 1. **SID（Statement ID）**
- ステートメントの一意な識別子
- ポリシー内で複数のステートメントを記述する場合、各ステートメントを区別するために使用
- オプション項目だが、管理の観点から含めることが推奨される

### 2. **Principal（プリンシパル）**
- アクセス権を与える対象を指定
- **対象の種類：**
  - IAM ユーザー
  - IAM ロール
  - AWSアカウント全体
  - 特定のサービス（例：CloudFront、Lambda）
  - 全ての主体（`"*"`）
- ワイルドカード「`*`」を使用すると、匿名ユーザーを含む全ての主体に対して適用

### 3. **Effect（エフェクト）**
- ポリシーの効果を指定
- **Allow**：指定されたアクションを許可
- **Deny**：指定されたアクションを拒否
- Denyは明示的な拒否となり、Allowよりも優先される

### 4. **Action（アクション）**
- 許可/拒否する具体的なS3 APIアクション
- **主なアクション：**
  - `s3:GetObject` - オブジェクト読み取り
  - `s3:PutObject` - オブジェクトアップロード
  - `s3:DeleteObject` - オブジェクト削除
  - `s3:ListBucket` - バケット内容の一覧表示
  - `s3:GetBucketPolicy` - バケットポリシー確認
  - `s3:PutBucketPolicy` - バケットポリシー変更
  - `s3:*` - 全てのS3アクション

### 5. **Resource（リソース）**
- ポリシーが適用される対象リソースを指定
- **ARN形式：**
  - `arn:aws:s3:::bucket-name` - バケット自体
  - `arn:aws:s3:::bucket-name/*` - バケット内の全てのオブジェクト
  - `arn:aws:s3:::bucket-name/folder/*` - 特定フォルダ配下のオブジェクト
- 複数のリソースを指定可能

### 6. **Condition（条件）** ※オプション
- ポリシーが適用される条件を細かく指定
- **よく使用される条件：**
  - **IP制限**：特定のIPアドレスからのアクセスのみ
  - **リファラ制限**：特定のWebサイトからのアクセスのみ
  - **SSL/TLS通信**：暗号化通信必須
  - **時間ベース**：特定の時間帯のみアクセス可能
  - **MFA認証**：MFAデバイスによる認証が必要

## バケットポリシーの用途例

- **静的Webサイトホスティング**：全員がオブジェクトを読み取り可能にする
- **ファイル共有**：特定のユーザー/ロールのみアクセス許可
- **ログ保存**：CloudTrail や ELB からのみログ書き込み可能
- **セキュリティ**：HTTPでのアクセスを拒否し、HTTPSのみ許可
- **クロスアカウントアクセス**：別のAWSアカウントからのアクセス許可

## 重要なポイント

- **優先度**：Deny（拒否）は Allowより優先される
- **評価ルール**：明示的な Allow がない場合は、デフォルトで拒否
- **複数のポリシー**：バケットポリシーと IAM ポリシー、ACL などが組み合わせて評価される
- **最小権限の原則**：必要最小限のアクセス権を付与することが推奨される
