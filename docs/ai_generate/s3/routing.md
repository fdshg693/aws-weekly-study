# S3のルーティング方法

このドキュメントでは、S3を使用した静的ウェブサイトホスティングにおける3つのルーティングアプローチについて説明します。[プロジェクト1：静的ウェブサイトのホスティング](../../goals/01_static_website_hosting.md)の各バージョンで適用される手法です。

---

## 1. S3単体でのルーティング方法

### 概要
S3のスタティックウェブサイトホスティング機能を使用して、直接S3のエンドポイント経由でコンテンツをルーティングします。最もシンプルな方法で、基本バージョンと中級バージョンで利用されます。

### ルーティングの仕組み

#### インデックスドキュメント（デフォルトドキュメント）
- ユーザーがディレクトリ（例：`/about/`）にアクセスすると、S3は自動的にそのディレクトリ内の指定されたインデックスファイル（例：`index.html`）を返します
- ルートパス（`/`）にアクセスすると、バケットのルートにあるインデックスファイルが返されます
- これにより、URLに明示的にファイル名を指定しなくても、ウェブサーバーのように動作します

#### エラーページの自動ルーティング
- ユーザーが存在しないパスにアクセスすると、通常は404エラーが発生します
- S3では、カスタムエラードキュメント（例：`404.html`）を設定できます
- 404エラーが発生した場合、S3は自動的にこのエラーページをルーティングして返すことで、ユーザーフレンドリーなエラーハンドリングを実現します

#### パススタイルとバーチャルホストスタイル
- **パススタイル**：`s3-region.amazonaws.com/bucket-name/object-key`形式でアクセス
  - ブラウザが複数のバケットのコンテンツを同じドメインから提供しているように見える可能性がある
- **バーチャルホストスタイル**：`bucket-name.s3-region.amazonaws.com/object-key`形式でアクセス
  - より直感的で、ドメインのようにバケット名を含む形式

### 特徴
- ✓ シンプルで設定が少ない
- ✓ S3のみで完結するため、追加のAWSサービスが不要
- ✓ 学習曲線が低い
- ✗ キャッシュ機能がないため、頻繁なアクセスでレイテンシーが大きい
- ✗ HTTPS対応が限定的（S3は基本的にHTTPでの提供）
- ✗ グローバルなアクセスに対して地理的に最適化されていない

### 適用バージョン
- **基本バージョン**：単一ページサイトをS3エンドポイント経由で提供
- **中級バージョン**：複数ページサイトをS3エンドポイント経由で提供、インデックスドキュメントとエラーページ設定

---

## 2. S3＋CloudFront（Function含めて）でのルーティング方法

### 概要
CloudFrontをS3の前に配置することで、グローバルなコンテンツ配信、キャッシング、HTTPS対応、さらにCloudFront Functionsを使用した動的ルーティングを実現します。発展バージョンの主要な手法です。

### CloudFrontの基本ルーティング

#### オリジンの指定
- S3バケットをCloudFrontのオリジン（コンテンツの源）として指定します
- CloudFrontは、世界中のエッジロケーション（キャッシュサーバー）からユーザーに最も近い場所からコンテンツを配信します

#### キャッシング戦略
- **Static Assets**（CSS、JavaScript、画像など）：長いキャッシュ有効期限（数日～数ヶ月）を設定
- **HTML**：短いキャッシュ有効期限（数分～数時間）を設定して、常に最新コンテンツを提供
- キャッシュにより、オリジンのS3へのリクエスト数が減少し、応答速度が向上します

#### HTTPS/SSL対応
- ACM（AWS Certificate Manager）で発行した証明書をCloudFrontに適用
- HTTPS経由で安全にコンテンツを配信し、ユーザーのブラウザと通信を暗号化します

### CloudFront Functionsを使用した動的ルーティング

#### ディレクトリ要求の処理
- CloudFront Functionsは、ユーザーの リクエストをインターセプト（途中で捕捉）し、動的にルーティングロジックを適用します
- ユーザーが`/about/`にアクセスした場合、Functionが自動的に`/about/index.html`にリクエストをリライト（書き換え）します
- これにより、S3単体では実現できない、より柔軟なURLハンドリングが可能になります

#### キャッシュバイパス
- 特定のパターンのリクエスト（例：API呼び出しなど）に対して、キャッシュをバイパスしてオリジンに直接アクセスさせることができます

#### リクエスト・レスポンスの変換
- User-Agentやリクエストのヘッダーに基づいて、異なるコンテンツにルーティングする
- 例えば、モバイルとデスクトップで異なるバージョンのコンテンツを提供することも可能です

### CloudFront Functionsの実行フロー

```
ユーザーリクエスト
    ↓
CloudFront受信
    ↓
[CloudFront Function - ビューアーリクエスト]
    ↓ リクエストリライト（例：/about/ → /about/index.html）
    ↓
キャッシュ確認
    ↓
キャッシュヒット → ユーザーへ返却
キャッシュミス → オリジン（S3）へリクエスト
    ↓
[CloudFront Function - ビューアーレスポンス]
    ↓ レスポンス変換（例：セキュリティヘッダーの追加）
    ↓
ユーザーへ返却
```

### 特徴
- ✓ グローバルなコンテンツ配信により、低レイテンシーを実現
- ✓ キャッシング機能により、スケーラビリティと応答速度が向上
- ✓ HTTPS対応で、セキュアな通信を提供
- ✓ CloudFront Functionsにより、複雑なルーティングロジックを実装可能
- ✓ DDoS攻撃への保護機能を備えている
- ✗ CloudFrontの利用コストが加算される
- ✗ キャッシュの無効化処理が必要な場合がある（ファイル更新時）

### 適用バージョン
- **発展バージョン**：複数ページサイト、エラーページ、HTTPS対応、グローバル配信が必要な場合

---

## 3. DNSを使ったルーティング方法

### 概要
Route 53（AWSのDNSサービス）を使用して、カスタムドメイン名をS3やCloudFrontにマッピングし、ユーザーフレンドリーなURLでアクセスを可能にします。

### DNSレコードによるルーティング

#### AレコードとAAAAレコード
- **Aレコード**：ドメイン名をIPv4アドレスにマッピングします
  - S3：S3エンドポイントのIPアドレスを指定
  - CloudFront：CloudFrontディストリビューションのIPアドレスを指定
- **AAAAレコード**：ドメイン名をIPv6アドレスにマッピングします

#### AliasレコードとCNAMEレコード
- **Aliasレコード**（Route 53特有）：AWSリソース（S3、CloudFront、ELBなど）に直接指定
  - 特別なメリット：クエリ数に基づいた料金が不要（通常のDNSクエリのみ）
  - CloudFrontやS3を指定する場合、Aliasレコードを使用するのがベストプラクティス
- **CNAMEレコード**：一つのドメイン名を別のドメイン名にエイリアス化
  - 例：`www.example.com` → `example.com`へのリダイレクト
  - S3やCloudFrontへのCNAMEマッピングも可能

### ドメイン統一のためのリダイレクト

#### www付きと非www URLの統一
- ドメイン所有者は、`example.com`と`www.example.com`のどちらか一方に統一したいケースが多くあります
- **方法1**：Route 53でAliasレコードを使い分ける
  - `example.com`と`www.example.com`のそれぞれ別のAliasレコードを作成
- **方法2**：リダイレクト用S3バケット
  - 非www URLからのリクセストを、www URLにリダイレクトするS3バケットを用意
  - Route 53でその非www URLをリダイレクト用バケットに指定

#### リダイレクト用バケットの役割
- リダイレクト用S3バケットの「ウェブサイトホスティング設定」で「リダイレクト」機能を有効化
- すべてのリクエストを別のドメイン（例：`www.example.com`）に301リダイレクトするように設定
- ユーザーが`example.com`にアクセスしても、ブラウザは自動的に`www.example.com`にアクセスします

### ルーティングの全体フロー（発展バージョン）

```
ユーザーがブラウザにドメインを入力
    ↓
DNS解決（Route 53）
    ↓
CloudFrontディストリビューションのエンドポイントに解決
    ↓
ユーザー → CloudFront（最寄りのエッジロケーション）
    ↓
キャッシュ確認
    ↓
キャッシュミス → S3オリジン
    ↓
CloudFront Function実行（リクエストリライト）
    ↓
S3からコンテンツ取得
    ↓
CloudFront Function実行（レスポンス変換）
    ↓
CloudFrontキャッシュ
    ↓
ユーザーへ返却（HTTPS）
```

### 特徴
- ✓ ユーザーフレンドリーなカスタムドメインでアクセス可能
- ✓ ドメイン統一により、SEO最適化とユーザー体験向上
- ✓ Route 53のAliasレコードは追加料金がない
- ✓ www付きと非www URLの自動リダイレクトが可能
- ✗ ドメイン登録費用が発生
- ✗ DNS設定に誤りがあるとサイトにアクセスできなくなる

### 適用バージョン
- **発展バージョン**：カスタムドメイン対応、HTTPS対応、グローバル配信が必要な場合

---

## 3つのルーティング方法の比較表

| 特徴 | S3単体 | S3＋CloudFront | DNSルーティング |
|------|--------|----------------|-----------------|
| セットアップ難度 | 低 | 中 | 中 |
| キャッシュ | ✗ | ✓ | - |
| グローバル配信 | ✗ | ✓ | ✓（CloudFront使用時） |
| HTTPS対応 | △ | ✓ | ✓（CloudFront使用時） |
| カスタムドメイン | ✗ | ✓（DNS併用時） | ✓ |
| 動的ルーティング | △ | ✓（Function使用時） | ✗ |
| コスト | 最小 | 中 | 低（ドメイン+DNS） |

---

## 学習フロー

1. **基本バージョン**：S3単体でのルーティングを理解
   - インデックスドキュメントの概念
   - エラーページのハンドリング

2. **中級バージョン**：複数ページサイトにおけるS3単体ルーティングの応用
   - ディレクトリ構造のルーティング
   - 複雑なサイト構造でのエラーページ設定

3. **発展バージョン**：S3＋CloudFront＋DNSによる統合ルーティング
   - CloudFrontの役割とキャッシング戦略
   - CloudFront Functionsによる動的なリクエスト処理
   - Route 53によるドメイン管理とAliasレコード
   - www統一戦略
